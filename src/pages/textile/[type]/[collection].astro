---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { client } from "../../../lib/pocketbase";

const { type, collection: collectionPath } = Astro.params;

if (!type || !collectionPath) {
    return Astro.redirect("/textile");
}

// SSR - загружаем данные на лету
const collection = await client
    .collection("collections")
    .getFirstListItem(`path="${collectionPath}"`);

// Обрабатываем изображения и текстили
const combinedItems = [];
for (let i = 1; i <= 100; i++) {
    const img = collection[`img${i}`];
    const textile = collection[`textile${i}`];
    if (img && textile) {
        combinedItems.push({ img, textile, id: `${collection.id}-${i}` });
    }
}

// Фильтруем спецификации
const specs = [
    { name: "Плотность", value: collection.plotnost },
    { name: "Состав", value: collection.sostav },
    { name: "Тест на истирание", value: collection.istiranie },
].filter((spec) => spec.value);

const seoData = {
    title: `${collection.name} - Ткани коллекции | Нортекс`,
    description:
        collection.description || `Ткани из коллекции ${collection.name}`,
};
---

<BaseLayout {...seoData}>
    <div class="container">
        <div class="title s">{collection.name}</div>
        <div class="text small-width">{collection.description}</div>
        <div class="text small-width s">{collection.description_type}</div>
        <br />

        {
            specs.map((spec) => (
                <div class="spec">
                    <div class="-name">{spec.name}</div>
                    <div class="-value">{spec.value}</div>
                </div>
            ))
        }

        <div class="product-list colors">
            {
                combinedItems.map((item) => (
                    <div class="-item">
                        <div>
                            <div class="-text">{item.textile}</div>
                            <img
                                class="-img product"
                                src={`${import.meta.env.PUBLIC_POCKETBASE_URL}/api/files/${collection.collectionId}/${collection.id}/${item.img}`}
                                alt={item.textile}
                                loading="lazy"
                            />
                        </div>
                    </div>
                ))
            }
        </div>
    </div>
</BaseLayout>

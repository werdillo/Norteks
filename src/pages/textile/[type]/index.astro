---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { client, getImageUrl } from "../../../lib/pocketbase";

const { type } = Astro.params;

if (!type) {
	return Astro.redirect("/textile");
}

// SSR - загружаем данные на лету
const [collections, category] = await Promise.all([
	client.collection("collections").getList(1, 50, { 
		filter: `category.path?="${type}"` 
	}),
	client.collection("categories").getFirstListItem(
		`path="${type}"`,
		{ fields: "name, description, rich_description, description_extended" }
	)
]);

const seoData = {
	title: `${category.name} - Коллекции тканей | Нортекс`,
	description: category.description || `Коллекции ${category.name} от компании Нортекс`,
};
---

<BaseLayout {...seoData}>
	<div class="container">
		<div class="title">{category.name}</div>
		<div class="text small-width">{category.description}</div>
		
		<div class="product-list collection">
			{collections.items.map((item) => (
				<a href={`/textile/${type}/${item.path}`}>
					<div class="-item">
						<div class="-text">{item.name}</div>
						<img
							class="-img collection"
							src={getImageUrl(item)}
							alt={item.name}
							loading="lazy"
						/>
					</div>
				</a>
			))}
		</div>
		
		{category.description_extended && (
			<div class="rich-editor" set:html={category.description_extended}></div>
		)}
	</div>
</BaseLayout>
